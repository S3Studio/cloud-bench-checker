# API server

Perform security baseline checks across multiple clouds according to benchmark recommendations
by providing APIs defined with [Swagger 2.0 (OpenAPI 2.0)](https://swagger.io/specification/v2/)

## Overview
This project is designed as a simple backend service to provide basic functional APIs.

To keep things simple, the following features will not be added, including:

* Data cache

The apiserver receives request data and returns response data, without caching it on the server.
The client needs to check the existence of data using the ids returned by the server,
and use it for later calls to the API rather than retrieving it repeatedly from the cloud.

* Authorization management

The apiserver uses profile files in the ".auth" subdirectory
to connect to the cloud of different environments.
However, the names of the profiles available are not published in the API.
The client needs to discuss with the server maintainer to make sure which profiles are available,
and set the value for the request if required. (Normally by setting "profile" in the header)

[go-swagger](https://goswagger.io/go-swagger/) is used to generate the main frame of apiserver.

## Deployment scenarios
This project is ready for use:

* In a single server, providing capabilities of resource listing, property extraction and validation.

or

* By deploying a listing server alone,
  with a custom application to manage the cache of resource from the cloud.
  Conf file and auth file are shared between servers.

or

* By deploying a validation server alone, to keep the validation rules secret,
  as the data source may be in an environment with strict access to connect the cloud,
  where the validation rules may not be appropriate to place.
  The data source can be another apiserver of this project,
  or data from command tools of the repo(with additional development).
  Conf file without validation infomation is shared with the data source.

## Prepare
### Configuration file
* Prepare a baseline configuration file of your interest based on the [reference](Baseline.md)

or

* Select one of the template configuration files from the [directory](/template/)

The file is loaded only once at startup, and kept static throughout the life of process of apiserver.

### Cloud auth config
Prepare authorization information from the corresponding cloud, and store it in the format of the [reference](Auth.md).

*DISCLAIMER*:
**ALWAYS** use the *READONLY* cloud authorizations (ak/sk/ClusterRole/etc...) to be configured in the project,
and **NEVER** trust any rule provided by others, even if it is cloned or downloaded from this site.

## Run locally
### Download binary
Download the command tool for your OS from the [release page](https://github.com/S3Studio/cloud-bench-checker/releases).
"apiserver" is the name of binary of apiserver.

The location of the configuration file must be "config.conf" in the same directory of the binary,
as it is generated by go-swagger and command argument list is not modified to keep things simple.

### Check environment
The `profile` section of the configuration file is ignored as the value requested by the user is used.
It is recommended that all auth configs are placed in the ".auth" subdirectory for the vary value of requests.

If the name of the profile in the request is `$ENV`,
apiserver will search authorization information in environment variables or `${HOME}/.kube/config`(for "k8s").

### Command-line argument
Run `./apiserver -h`, and the instruction will look like this:
```
Usage:
  xxx/apiserver [OPTIONS]

API for https://github.com/S3Studio/cloud-bench-checker described with Swagger 2.0


Application Options:
      /scheme:             the listeners to enable, this can be repeated and defaults to the schemes in the swagger spec
      /cleanup-timeout:    grace period for which to wait before killing idle connections (default: 10s)
      /graceful-timeout:   grace period for which to wait before shutting down the server (default: 15s)
      /max-header-size:    controls the maximum number of bytes the server will read parsing the request header's keys and values, including the       
                           request line. It does not limit the size of the request body. (default: 1MiB)
      /socket-path:        the unix socket to listen on (default: /var/run/cloud-bench-checker-api.sock)
      /host:               the IP to listen on (default: localhost) [%HOST%]
      /port:               the port to listen on for insecure connections, defaults to a random value [%PORT%]
      /listen-limit:       limit the number of outstanding requests
      /keep-alive:         sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop
                           mid-download) (default: 3m)
      /read-timeout:       maximum duration before timing out read of the request (default: 30s)
      /write-timeout:      maximum duration before timing out write of the response (default: 30s)
      /tls-host:           the IP to listen on for tls, when not specified it's the same as --host [%TLS_HOST%]
      /tls-port:           the port to listen on for secure connections, defaults to a random value [%TLS_PORT%]
      /tls-certificate:    the certificate to use for secure connections [%TLS_CERTIFICATE%]
      /tls-key:            the private key to use for secure connections [%TLS_PRIVATE_KEY%]
      /tls-ca:             the certificate authority file to be used with mutual tls auth [%TLS_CA_CERTIFICATE%]
      /tls-listen-limit:   limit the number of outstanding requests
      /tls-keep-alive:     sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop mid-download)
      /tls-read-timeout:   maximum duration before timing out read of the request
      /tls-write-timeout:  maximum duration before timing out write of the response

Help Options:
  /?                       Show this help message
  /h, /help                Show this help message
```

More details can be found from the [reference](https://goswagger.io/go-swagger/generate/server/).

For a quick start, you can run the following command:
```sh
./apiserver --port 2480
```
And then use a browser to visit "127.0.0.1:2480/api/docs" for further exploration.

## Run with Docker
### Docker image
The docker image is published [here](https://github.com/S3Studio/cloud-bench-checker/pkgs/container/cloud-bench-checker-apiserver).

Alternatively, a custom image can be built with the [Dockerfile of apiserver](/Dockerfile-apiserver) using the following command:
```sh
docker build -t {image_name} -f ./Dockerfile-apiserver .
```

### Command to start Docker container
Considering the template of the following command:
```sh
docker run -d -p 2480:2480 -v {conf_file}:/app/config.conf -v {auth_dir}:/app/.auth ghcr.io/s3studio/cloud-bench-checker-apiserver:latest
```

#### -p {local_port}:2480
The Docker image uses "2480" as the default port,
which can be remapped on any "local_port" by Docker.

If a different port inside the container needs to be used in some situation,
pass the port argument along with an `--entrypoint` argument to Docker:
```sh
docker {...} --entrypoint /app/main ghcr.io/s3studio/cloud-bench-checker-apiserver:latest --port {port} {...}
```

#### -v {conf_file}:/app/config.conf
The Docker image uses "/app/config.conf" as the location of baseline configuration file.
The file is loaded only once at startup,
and it is recommended to restart the container if the file changes.

#### -v {auth_dir}:/app/.auth
The `profile` section of the configuration file is ignored as the value requested by the user is used.
It is recommended that all auth configs are mounted in the ".auth" subdirectory for the vary value of requests.

#### Other argument
Other argument of the binary can be placed after the image name like:
```sh
docker {...} ghcr.io/s3studio/cloud-bench-checker-apiserver:latest --host 0.0.0.0
```

See the reference of [document](#command-line-argument)
or the [external link](https://goswagger.io/go-swagger/generate/server/)

## Instruction for client-side
The steps required for a client to experience the full capabilities are as follows:

1. Talk to the server maintainer to get the available profiles of cloud.
1. Get the ids of Baseline with `/baseline/getIds`.
   One or more tags can be set to filter the interest Baseline.
1. Get the ids of Listor used by each Baseline with `/baseline/getListorId`.
1. Deduplicate the ids, and get the definition of each Listor with `/listor/getDefinition`.
   Check the `cloud_type` of definition to make sure
   whether the Listor will connect to the cloud that the client is interested in.
1. Get resource data from each Listor of interest with `/listor/listData`.
   "profile" param is required.
1. For each Baseline, merge the resource data it needs into a list,
   and then send the list to get properties with `/baseline/getProp`.
   "profile" param is required.
1. For each result that contains porperties in the respond of the previous call,
   send it back without modification to get validation result with `/baseline/validate`.

See "TestApiserverIntegration" function of the [test file](/test/apiserver/apiserver_test.go) as an example.

## Development reference
* If the [swagger specification](/doc/api_swagger.yml) changes, use the following command to generate updated code:
```sh
swagger generate server --spec ./doc/api_swagger.yml --model-package ./pkg/server-model --server-package ./internal/server --main-package ../bin/apiserver
```
